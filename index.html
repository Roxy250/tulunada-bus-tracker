<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tulunada Bus Tracker</title>
  <style>
    /* style.css embedded for convenience */
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --accent:#1d4ed8;
      --muted:#6b7280;
      --glass: rgba(0,0,0,0.04);
      --maxw:980px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:linear-gradient(180deg,var(--bg),#eef2ff 60%);
      color:#0f172a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:28px;
      display:flex;
      justify-content:center;
    }
    .wrap{width:100%;max-width:var(--maxw);}
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:20px;
      margin-bottom:18px;
    }
    h1{margin:0;font-size:20px;letter-spacing:0.2px}
    .sub{color:var(--muted);font-size:13px}
    .controls{
      display:flex;gap:12px;align-items:center;
    }
    .clock{
      background:var(--card);
      padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(18,38,63,0.06);
      display:flex;flex-direction:column;align-items:flex-end;
      min-width:140px;text-align:right;
    }
    #time{font-weight:700;font-size:18px}
    .card{
      background:var(--card);
      padding:18px;border-radius:12px;box-shadow:0 10px 30px rgba(18,38,63,0.06);
      margin-bottom:14px;
    }
    .controls .select{
      padding:10px 12px;border-radius:10px;border:1px solid #e6e9ef;background:transparent;
      font-size:14px;
    }
    .info-row{display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap}
    .meta{color:var(--muted);font-size:13px}
    .bus-list{margin-top:6px;}
    .bus-row{
      display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:8px;
      border:1px solid var(--glass);margin-bottom:8px;background:linear-gradient(180deg,#fff,#fcfcff);
    }
    .bus-left{display:flex;gap:12px;align-items:center}
    .badge{
      background:var(--accent);color:white;padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px;
      box-shadow:0 6px 14px rgba(29,78,216,0.18);
    }
    .bus-meta{font-size:14px}
    .muted{color:var(--muted);font-size:13px}
    .empty{color:var(--muted);padding:16px;text-align:center}
    footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
    /* Responsive */
    @media (max-width:700px){
      body{padding:12px}
      header{flex-direction:column;align-items:flex-start;gap:8px}
      .clock{align-items:flex-start;text-align:left;min-width:unset}
      .bus-row{flex-direction:column;align-items:flex-start;gap:8px}
      .badge{align-self:flex-start}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Tulunada Bus Tracker</h1>
        <div class="sub">Mangalore → Karkala — Select a stop to see upcoming buses</div>
      </div>

      <div class="controls">
        <div class="clock card" aria-live="polite">
          <div class="muted">Current time</div>
          <div id="time">--:--</div>
          <div id="date" class="muted" style="font-size:12px"></div>
        </div>
      </div>
    </header>

    <div class="card">
      <div class="info-row">
        <label for="stopSelect" class="muted">Choose stop</label>
        <select id="stopSelect" class="select">
          <option value="">Loading stops…</option>
        </select>

        <label for="showCount" class="muted">Show</label>
        <select id="showCount" class="select" style="width:80px">
          <option value="5">Next 5</option>
          <option value="10" selected>Next 10</option>
          <option value="20">Next 20</option>
        </select>

        <button id="refreshBtn" class="select" title="Refresh data">Refresh</button>
      </div>

      <div id="nextTitle" class="muted">Upcoming buses for <strong id="stopName">—</strong></div>
      <div id="list" class="bus-list" aria-live="polite">
        <div class="empty">Loading data…</div>
      </div>
    </div>

   /* <div class="card">
      <div class="muted">How it works</div>
      <ul>
        <li>App loads your CSV from GitHub (raw CSV URL). CSV must have headers like:
          <code>bus_name,source,destination,departure_time,arrival_time,haleangady,nitte</code></li>
        <li>Stop columns are any headers other than: <code>bus_name,source,destination,departure_time,arrival_time</code>.</li>
        <li>Times are 24-hour format <code>HH:MM</code>. Empty cells are ignored.</li>
      </ul>
      <div class="muted">Tip: Upload your CSV to your repo, open the file and click <strong>Raw</strong> — paste that URL into the CSV_URL variable in the script below.</div>
    </div>

    <footer>Made for you — copy this file into a GitHub Pages repo and change CSV_URL</footer>
  </div>*/

  <script>
    /************************************************************************
     * CONFIG: put your raw GitHub CSV URL here (paste the "Raw" file URL)
     * Example: https://raw.githubusercontent.com/youruser/yourrepo/main/data.csv
     ************************************************************************/
    const CSV_URL = "https://raw.githubusercontent.com/Roxy250/tulunada-bus-tracker/refs/heads/main/Bus%20Tracker%20-%20Manglore%20-%20Karkala.csv";
    // --- end config

    // Known meta column names (case-insensitive)
    const META_COLS = ["bus_name","from","source","to","destination","departure","departure_time","arrival","arrival_time"];

    // DOM
    const timeEl = document.getElementById("time");
    const dateEl = document.getElementById("date");
    const stopSelect = document.getElementById("stopSelect");
    const listEl = document.getElementById("list");
    const stopNameEl = document.getElementById("stopName");
    const refreshBtn = document.getElementById("refreshBtn");
    const showCount = document.getElementById("showCount");

    let table = [];      // parsed CSV rows (objects)
    let stopCols = [];   // stop column keys in CSV

    // CLOCK
    function updateClock(){
      const now = new Date();
      const hh = now.getHours().toString().padStart(2,"0");
      const mm = now.getMinutes().toString().padStart(2,"0");
      timeEl.textContent = hh + ":" + mm;
      dateEl.textContent = now.toLocaleDateString();
    }
    setInterval(updateClock,1000);
    updateClock();

    // UTILS
    function parseCSV(text){
      // Simple CSV parser (handles basic commas). Assumes first row headers.
      const rows = text.split(/\r?\n/).map(r=>r.trim()).filter((r,i)=>r!=="" || i===0); // keep header even if empty row removed
      if(!rows.length) return {headers:[],data:[]};
      // split only by commas, but also handle commas inside quotes (basic)
      const parseRow = (line) => {
        const out=[]; let cur=""; let inQ=false;
        for(let i=0;i<line.length;i++){
          const ch=line[i];
          if(ch === '"' ) { inQ=!inQ; continue; }
          if(ch === ',' && !inQ){ out.push(cur.trim()); cur=""; continue; }
          cur += ch;
        }
        out.push(cur.trim());
        return out;
      };
      const headers = parseRow(rows[0]).map(h => h.replace(/\uFEFF/g,'').trim());
      const data = [];
      for(let i=1;i<rows.length;i++){
        if(!rows[i]) continue;
        const cols = parseRow(rows[i]);
        // ensure length
        while(cols.length < headers.length) cols.push("");
        const obj = {};
        for(let j=0;j<headers.length;j++){
          obj[headers[j]] = cols[j] === undefined ? "" : cols[j];
        }
        data.push(obj);
      }
      return {headers,data};
    }

    function normalizeHeader(h){
      return h.trim().toLowerCase().replace(/\s+/g,'_');
    }

    function detectStopColumns(headers){
      const stops = [];
      headers.forEach(h=>{
        const low = h.trim().toLowerCase();
        // treat as meta if header contains any meta keyword
        const isMeta = META_COLS.some(m => low === m || low.includes(m));
        if(!isMeta){
          // ignore completely empty names
          if(h && h.trim()!=="") stops.push(h);
        }
      });
      return stops;
    }

    function parseTimeToDateToday(hhmm){
      if(!hhmm) return null;
      // accept "HH:MM" or "H:MM" or "HH:MM AM/PM" (we expect 24-hr)
      let t = hhmm.toString().trim();
      // strip whitespace and non-digit/colon/AMPM
      // handle "07:26" or "7:26"
      const match = t.match(/(\d{1,2}):(\d{2})/);
      if(!match) return null;
      const hh = parseInt(match[1],10);
      const mm = parseInt(match[2],10);
      if(isNaN(hh) || isNaN(mm)) return null;
      const now = new Date();
      const dt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
      // if time seems passed, treat as next day arrival; we'll handle by adding 24h when sorting
      return dt;
    }

    function loadCSV(url){
      listEl.innerHTML = '<div class="empty">Loading CSV…</div>';
      return fetch(url)
        .then(r => {
          if(!r.ok) throw new Error("Failed to fetch CSV. Check CSV_URL and CORS.");
          return r.text();
        })
        .then(text => {
          const parsed = parseCSV(text);
          table = parsed.data;
          // detect stop columns
          stopCols = detectStopColumns(parsed.headers);
          if(stopCols.length === 0){
            listEl.innerHTML = '<div class="empty">No stop columns detected in CSV. Make sure your headers include stop columns (e.g., haleangady, nitte).</div>';
            stopSelect.innerHTML = `<option value="">No stops</option>`;
            return;
          }
          populateStopSelect(stopCols);
          renderForSelectedStop();
        })
        .catch(err=>{
          console.error(err);
          listEl.innerHTML = `<div class="empty">Error loading CSV: ${err.message}</div>`;
        });
    }

    function populateStopSelect(stops){
      stopSelect.innerHTML = "";
      const chosen = localStorage.getItem("tulunada_last_stop");
      stops.forEach((s,idx)=>{
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        if(chosen && chosen === s) opt.selected = true;
        stopSelect.appendChild(opt);
      });
      // set displayed stop name
      const sel = stopSelect.value || stops[0];
      stopNameEl.textContent = sel || "—";
    }

    function renderForSelectedStop(){
      const stop = stopSelect.value || stopCols[0];
      if(!stop){
        listEl.innerHTML = '<div class="empty">Select a stop to see upcoming buses.</div>';
        return;
      }
      stopNameEl.textContent = stop;
      localStorage.setItem("tulunada_last_stop", stop);

      // build list of buses that have a time for this stop
      const now = new Date();
      const items = [];
      table.forEach(row=>{
        // find any header that matches stop exactly (case-sensitive header names are preserved)
        const rawTime = row[stop];
        if(rawTime && rawTime.toString().trim() !== ""){
          const dt = parseTimeToDateToday(rawTime);
          if(!dt) return;
          // if dt < now, consider it as next day (so it appears after upcoming)
          let displayDt = new Date(dt);
          if(displayDt < now) displayDt = new Date(displayDt.getTime() + 24*60*60*1000);
          const diffMs = displayDt - now;
          items.push({
            bus_name: row["Bus Name"] || row["bus_name"] || row["BusName"] || row["busname"] || row["bus"] || row["Bus"],
            source: row["From"] || row["from"] || row["source"] || "",
            destination: row["To"] || row["to"] || row["destination"] || "",
            stop_time_raw: rawTime,
            time_dt: displayDt,
            diffMs
          });
        }
      });

      if(items.length === 0){
        listEl.innerHTML = '<div class="empty">No buses found for this stop today (or stop column values empty).</div>';
        return;
      }

      // sort by diff ascending
      items.sort((a,b)=>a.diffMs - b.diffMs);

      // show first N from showCount
      const n = parseInt(showCount.value || "10",10);
      const show = items.slice(0,n);

      listEl.innerHTML = "";
      show.forEach(it=>{
        const row = document.createElement("div");
        row.className = "bus-row";
        const left = document.createElement("div");
        left.className = "bus-left";
        const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = it.bus_name || "—";
        const meta = document.createElement("div");
        meta.className = "bus-meta";
        meta.innerHTML = `<div><strong>${it.stop_time_raw}</strong> <span class="muted">(${it.source} → ${it.destination})</span></div>`;
        left.appendChild(badge);
        left.appendChild(meta);

        const right = document.createElement("div");
        right.style.textAlign = "right";
        const remainMin = Math.round(it.diffMs / 60000);
        const when = it.time_dt;
        const hh = when.getHours().toString().padStart(2,"0");
        const mm = when.getMinutes().toString().padStart(2,"0");
        const whenStr = `${hh}:${mm}`;
        const remText = remainMin <= 0 ? "due" : (remainMin < 60 ? `${remainMin} min` : `${Math.floor(remainMin/60)} h ${remainMin%60} m`);
        right.innerHTML = `<div style="font-weight:700">${whenStr}</div><div class="muted" style="font-size:12px">${remText}</div>`;

        row.appendChild(left);
        row.appendChild(right);
        listEl.appendChild(row);
      });
    }

    // events
    stopSelect.addEventListener("change", ()=>renderForSelectedStop());
    showCount.addEventListener("change", ()=>renderForSelectedStop());
    refreshBtn.addEventListener("click", ()=>loadCSV(CSV_URL));

    // auto-refresh every 60s
    setInterval(renderForSelectedStop, 60*1000);

    // initial load
    if(!CSV_URL || CSV_URL.includes("YOUR_USERNAME")){
      listEl.innerHTML = `<div class="empty">Please edit the CSV_URL variable in the script and paste your raw GitHub CSV file URL.</div>`;
    } else {
      loadCSV(CSV_URL);
    }

  </script>
</body>
</html>
